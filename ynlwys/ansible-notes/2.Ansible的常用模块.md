Ansible的常用模块
==============

> Ansible 通过模块来做一些远程管理的操作
>
> 几乎Ansible 的所有操作都是通过模块来完成的


---



#### Ansible所有自带模块查看

- ansible-doc -l : 查看Ansible有哪些自带模块

- ansible-doc -s file : 查看Ansible中file模块的的参数使用说明


#### Absible常用模块说明

1.setup 模块

```
   简介：
    该模块用于获客户机信息、各种信息


   使用方式 ： ansible -i elk elk -m setup

   参数说明：
    -i elk elk ： 指定host文件以及主机组
    -m setup   ： 指定模块

```


2.ping 模块

```
   简介：
    该模块用于检测客户机是否存活 存活返回 pong


   使用方式 ： ansible -i elk elk -m ping

```

3.file 模块

```
   简介：
    该模块用于获客户机信息、各种信息


   使用方式 ： ansible -i elk elk -m file -a "src=/etc dest=/tmp/ state=link"

   参数说明：
    - a "" ： 参数在双引号内
    
   其他命令参数：
    force：强制执行 参数为 yes or no
    recurse：递归设置文件属性 对目录有效
    path：定义文件的路径
    owner：设置文件的属主
    mode：定义文件or目录的权限[写法1：u=rw,g=r,o=r、写法2：u+rw,g-wx,o-rwx]
    src：原路径 state=link 参数使用
    dest：被连接到的路径 只结合用于state=link 参数
    group：定义文件or目录的属组
    state：
        directory：如果目录不存在创建目录
        file：文件不存在也不会创建
        link：创建软连接
        hard：创建硬链接
        touch：文件不存在 -> 创建、存在 -> 更新修改时间
        absend：删除 或者 取消连接
    
    具体使用还请结合具体需求进行使用
    
    生产应用案例：
     1.ansible elk -u root -m file -a "src=/proc/cpuinfo dest=/tmp/cpuinfo state=link" 创建软连接
     2.ansible elk -u root -m file -a "path=/tmp/cpuinfo state=absent" 删除软连接
     3.ansible elk -u root -m file -a "path=/tmp/adbtest/ state=directory mode='u=rw,g=r,o=r'" 创建文件夹
     4.ansible elk -u root -m file -a "path=/tmp/adbtest/  state=absent" 删除文件夹

```

4.copy模块

```
   简介：
    该模块用于复制文件到远程主机


   使用方式 ： ansible api -m copy -a 'src=/data/api.war dest=/opt/tomcat/webapps/api.war‘

   功能说明：
    将api.war 复制到 api 服务器的/opt/tomcat/webapps 路径
    
   其他命令参数：
    backup：如果文件存在是否覆盖 那么该选项可以源文件进行备份 yes|no
    src：指定源文件 如果 存在 / 那么只会复制目录下面的内容
    content：代替src 可以直接将传输文件进行输入
    dest：将源文件复制到远程主机的目录地址
    directory_mode：递归设定目录权限 默认为系统默认权限
    force：强制覆盖
    others：所有的file选项都可使用
    
    具体使用还请结合具体需求进行使用
    
    生产应用案例：
     copy文件到对应的服务器路径 并且修改对应权限、属主、属组
     1.ansible api -m copy -a 'src=/data/api.war dest=/opt/tomcat/webapps/api.war owner=api mode=775 group=api' && echo 'api.war copy success'
     

```

5.command模块

```
   简介：
    该模块是ansible的默认模块


   使用方式 ： ansible elk -a "chdir=/root/ ls -alh"

   功能说明：
    - a "" ：可以在此执行shell命令
    
   其他命令参数：
    creates：文件路径 如果存在则后面的命令不会执行
    chdir：在执行命令前切换到指定目录去 相当于cd命令
    free_form：要执行的linux指令
    removes：文件路径 当文件不存在则命令不执行
    executable：绝对路径 切换到shell来执行指令 
    
    具体使用还请结合具体需求进行使用
    
    生产应用案例：
     1.ansible elk -u root -a "executable=/bin/bash ii /opt/create.sh" 使用远程服务器上的shell执行create.sh
     2.ansible api -m shell -a 'rm -rf /opt/tomcat/webapps/api*' 删除远程服务器上的文件
     
```

6.shell模块

```
   简介：
    该模块用于执行shell命令


   使用方式 ： ansible elk -m shell -a "/opt/test.sh"

   功能说明：
    通过shell模块执行shell脚本
    
   其他命令参数：
    creates：文件路径 如果存在则后面的命令不会执行
    chdir：在执行命令前切换到指定目录去 相当于cd命令
    free_form：要执行的linux指令
    removes：文件路径 当文件不存在则命令不执行
    executable：绝对路径 切换到shell来执行指令 
    
    具体使用还请结合具体需求进行使用
    
    生产应用案例：
     1.ansible nginx -m shell -a 'nginx_maintenance.sh add' 通过ansible给nginx服务器组批量挂载维护页面
     
     
    备注：默认的command是不支持管道 而shell和raw是支持的
    
    官方声明：能用command的地方尽量不要使用shell和raw

```


7.service模块

```
   简介：
    该模块用于执行shell命令


   使用方式 ： ansible elk -m service -a "name=nginx state=restarted enabled=yes"

   功能说明：
    通过service模块对nginx 服务进行重启 需要保证远程机service nginx restart可以执行
    
   其他命令参数：
    arguments：参数
    enabled：开机启动 yes|no
    name：服务名称
    pattern：如果通过status指令查看服务状态时没有响应 就会通过ps+该模式进行查找找到则认为服务运行中
    runlevel：运行级别
    sleep：restart 时stop和start中间睡眠的时间
    state：对服务进行启动、重启、停止、重载等操作
    具体使用还请结合具体需求进行使用
    
    生产应用案例：
     1.ansible test -m service -a "name=network state=restarted args=eth0" 重启eth0网卡

```

8.cron模块

```
   简介：
    该模块用于执行计划任务


   使用方式 ： ansible elk -m cron -a "name='test cron' hour=2 job='ls -alh /'"

   功能说明：
    通过cron模块创建定时任务 每天凌晨两点对根目录进行查看
    
   其他命令参数：
    backup：修改之前做备份
    cron_file：指定cron文件 会替换cron.d 目录下的用户任务计划
    day：日(1-31 * */2 ......)
    hour：小时(0-23 * */2 ......)
    minute：分钟(0-60 * */2 ......)
    month：月(1-12 * */2 ......)
    weekday：周(0-7 * ......)
    job：要执行的任务 依赖于state=present
    name: 任务描述 最终会被添加到crontab列表中并注释
    special_time: 指定什么时候执行比如@reboot
    state: 该任务是创建还是删除
    user: 运行计划任务的用户
    
    具体使用还请结合具体需求进行使用
    
    生产应用案例：
     1.ansible elk -m cron -a "name='scan directroy' minute='*/1' job='ls -alh /opt > ~/scanDirectroy.log'" 定时扫描目录
     2.ansible elk -m cron -a "name='test cron' state=absent" 删除定时任务


```

9.yum模块

```
   简介：
    该模块用于yum对软件进行管理 - Readhat Type


   使用方式 ： ansible elk -m yum -a "name='httpd' state=latest"

   功能说明：
    通过yum模块对httpd应用的最新版进行安装
    
   其他命令参数：
    config_file：yum配置文件
    disable_gpg_check：关闭gpg_check
    disablerepo：启用某个源
    name：软件的名字、url、本地rpm包路径
    state：状态 present-安装|absent-卸载|latest-安装最新版
    
    
    具体使用还请结合具体需求进行使用
    
    生产应用案例：
     1.
    
```

10.filesystem模块

```
   简介：
    该模块用于在设备上创建文件系统


   使用方式 ： ansible elk -m filesystem 'fstype=ext4 force=yes opts=-F dev=/dev/loop0'

   功能说明：
    通过filesystem模块对/dev/loop0进行格式化 文件类型ext4 强制格式化 
    
   其他命令参数：
    dev：目标设备
    force：强制创建 强行格式化
    fatype：格式化类型
    opts：传递给mkfs的参数
    
    具体使用还请结合具体需求进行使用

```


11.user模块

```
   简介：
    该模块用于在设备上创建文件系统


   使用方式 ： ansible elk -m user -a "name='yt' createhome=yes home=/home/yt password='123456' shell=/bin/bash"

   功能说明：
    通过user模块创建用户yt 创建家目录 添加密码 指定shell
    
   其他命令参数：
    home: 指定家目录
    groups: 指定组
    uid: 指定uid
    password: 指定密码
    name: 指定名字
    createhome: 是否创建家目录 yes|no
    system: 是否指定为系统用户
    remove: yes|no state为absent时 是否删除家目录 
    state: 创建还是删除 
    shell: 指定用户的shell环境
    
    
    具体使用还请结合具体需求进行使用
    
    实例:
     1.ansible elk -m user -a "name='yt' state=absent remove=yes" 删除yt用户 并且 删除家目录

```



#### 关于Ansible的第一条命令的解释
- `ansible : 工具的主程序、主命令`
- `-i : 指定hosts文件的参数 如果不是使用则使用默认文件`
- `elk[1] : 配置文件路径 如 /etc/ansible/hosts` 
- `elk[2] : hosts配置文件中的主机组 如serverName`
- `-u root : 指定远程执行用户为root`
- `-m command : 指定模块为command`
- `-a 'uptime' : 指定远程执行的命令`
- `-k : 指定为输入密码 如果已做无密验证 可忽略此选项`
- `-h : -h or --help 查看更多选项`

#### Ansible的Hosts文件
最简配置 ：
```shell
[serverName1]
www.ynlwyscloud.com
db-[a:f].example.com
localhost   ansible_connection=local
www.ynlwyscloud.com ansible_connection=ssh ansible_ssh_user=ynlwys
jumper ansible_ssh_port=22 ansible_ssh_host=192.168.122.11

[serverName2]
192.168.122.[1-9] http_port=80 maxRequestsPerChild=8080
192.168.122.150:22
192.168.122.45
192.168.122.11

[serverName2:vars]
server_hosts=192.168.1.1

[serverName:children]
serverName1
serverName2

```

其他方式 ：

- 可以配置ip地址 如：192.168.122.11
- 可以配置域名 如：www.ynlwyscloud.com
- 可以配置一个或者多个组 如：[serverName1]、[serverName2]
- 可以更换默认端口 如：192.168.122.150:22
- 可以添加别名根据端口和ip 如：jumper ansible_ssh_port=22 ansible_ssh_host=192.168.122.11
- 可以批量添加域名或者ip 如：db-[a:f].example.com、192.168.122.[1-9]
- 可以添加本地连接 如：localhost   ansible_connection=local
- 可以设定某域名或ip的连接方式和连接用户 如：www.ynlwyscloud.com ansible_connection=ssh ansible_ssh_user=ynlwys
- 可以设定变量给主机 如：192.168.122.[1-9] http_port=80 maxRequestsPerChild=8080
- 可以设定变量给主机组 如：[serverName2:vars] \ server_hosts=192.168.1.1
- 可以进行主机组嵌套 如：[serverName:children] \ serverName1 \ serverName2
- ~~可以分文件定义Host和Group变量 会在ansible-playbook中进行说明~~


---